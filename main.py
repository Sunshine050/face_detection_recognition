# import "‡πÇ‡∏°‡∏î‡∏π‡∏• Pro" ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
from core.detector import detect_faces 

# import "‡πÇ‡∏°‡∏î‡∏π‡∏•" ‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
from core.recognizer import recognize_faces

import cv2
import time

print("[INFO] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...")

# ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á (0 ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å)
cap = cv2.VideoCapture(0)

# ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏´‡∏°
if not cap.isOpened():
    print("[ERROR] ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ")
    exit()

# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏î FPS (Frames Per Second)
prev_frame_time = 0
new_frame_time = 0

print("[INFO] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô... ‡∏Å‡∏î 'q' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°")

# --- ‡∏ß‡∏á‡∏à‡∏£‡∏´‡∏•‡∏±‡∏Å (Loop) ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô ---
while True:
    # 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏ü‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á
    ret, frame = cap.read()
    if not ret:
        print("[ERROR] ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡πÄ‡∏ü‡∏£‡∏°‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ")
        break
        
    # ‡∏û‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û (‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏Ñ‡∏°‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô)
    frame = cv2.flip(frame, 1)
    
    # 2. üöÄ (‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Detector
    #    ‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û frame ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
    #    ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô list ‡∏Ç‡∏≠‡∏á ((x,y,w,h), confidence)
    detected_results = detect_faces(frame)
    
    # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î (boxes) ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (confidences)
    boxes = []
    confidences = []
    for (box, conf) in detected_results:
        boxes.append(box)
        confidences.append(conf)

    # 3. üöÄ (‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Recognizer
    #    ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á BGR -> RGB ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ recognizer ‡∏ä‡∏≠‡∏ö RGB
    rgb_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
    
    #    ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û RGB ‡πÅ‡∏•‡∏∞ "‡∏û‡∏¥‡∏Å‡∏±‡∏î" ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏´‡∏≤‡πÄ‡∏à‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
    #    ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô list ‡∏Ç‡∏≠‡∏á "‡∏ä‡∏∑‡πà‡∏≠"
    names = recognize_faces(rgb_frame, boxes)
    
    # 4. ‡∏ß‡∏≤‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡∏ö‡∏ô‡∏à‡∏≠
    
    # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏≤‡∏° "‡∏û‡∏¥‡∏Å‡∏±‡∏î" ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏´‡∏≤‡πÄ‡∏à‡∏≠
    for i, (x, y, w, h) in enumerate(boxes):
        # ‡∏î‡∏∂‡∏á "‡∏ä‡∏∑‡πà‡∏≠" ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏≤‡πÄ‡∏à‡∏≠
        name = names[i]
        
        # ‡∏î‡∏∂‡∏á "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à" ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏´‡∏≤‡πÄ‡∏à‡∏≠
        confidence = confidences[i]
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á Text ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á
        text_name = f"Name: {name}"
        text_conf = f"Conf: {confidence * 100:.2f}%"
        
        # --- ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö ---
        # (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÑ‡∏î‡πâ, ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ñ‡πâ‡∏≤ Unknown)
        color = (0, 0, 255) if name == "Unknown" else (0, 255, 0)
        cv2.rectangle(frame, (x, y), (x + w, y + h), color, 2)
        
        # --- ‡∏ß‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ % ---
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏ó‡∏∂‡∏ö
        y_text_bg = y - 40 if y - 40 > 0 else y + 10 # ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        cv2.rectangle(frame, (x, y_text_bg), (x + w, y), color, cv2.FILLED)
        
        # ‡∏ß‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠
        cv2.putText(frame, text_name, (x + 6, y - 24), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 255, 255), 1)
        # ‡∏ß‡∏≤‡∏î %
        cv2.putText(frame, text_conf, (x + 6, y - 8), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 255, 255), 1)

    # 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á FPS
    new_frame_time = time.time()
    fps = 1 / (new_frame_time - prev_frame_time)
    prev_frame_time = new_frame_time
    cv2.putText(frame, f"FPS: {int(fps)}", (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 2)

    # 6. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    cv2.imshow("Face Detection and Recognition (PRO)", frame)
    
    # 7. ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° 'q' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

# --- ‡∏à‡∏ö Loop ---
print("[INFO] ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°...")
cap.release()
cv2.destroyAllWindows()